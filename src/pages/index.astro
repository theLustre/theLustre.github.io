---
import MainContent from "../components/MainContent.astro";
import Profile from "../components/Profile.astro";
import Statistics from "../components/Statistics.astro";
import Tags from "../components/Tags.astro";
import PostCard from "../components/PostCard.astro";
import Spotify from "../components/Spotify.astro";

// 自动检测所有模块：获取 posts 目录下所有子目录中的文章
const allPosts = await Astro.glob("./posts/**/*.md");

// 处理文章数据的辅助函数
function processPost(post: any, moduleName: string) {
	return {
		title: post.frontmatter?.title ?? "未命名文章",
		description: post.frontmatter?.description ?? "",
		date: post.frontmatter?.lastUpdated
			? new Date(post.frontmatter.lastUpdated)
			: post.frontmatter?.pubDate
				? new Date(post.frontmatter.pubDate)
				: null,
		url: post.url || "#",
		tags: (post.frontmatter?.tags as string[]) || [],
		image: post.frontmatter?.image?.url || post.frontmatter?.image || null,
		imageAlt: post.frontmatter?.image?.alt || post.frontmatter?.imageAlt || null,
		moduleName,
	};
}

// 从 URL 提取模块名称（/posts/模块名/文件名）
function extractModuleName(url: string): string {
	// url 格式类似: /posts/专业技术/AR增强现实apk
	const parts = url.split("/");
	if (parts.length >= 3 && parts[1] === "posts") {
		return parts[2]; // 返回模块名
	}
	return "未分类";
}

// 按模块自动分组文章
const moduleMap = new Map<string, any[]>();

allPosts.forEach((post) => {
	const url = post.url || "";
	const moduleName = extractModuleName(url);
	const processedPost = processPost(post, moduleName);
	
	if (processedPost.url !== "#") {
		if (!moduleMap.has(moduleName)) {
			moduleMap.set(moduleName, []);
		}
		moduleMap.get(moduleName)!.push(processedPost);
	}
});

// 转换为数组并按模块名排序，每个模块内的文章按日期排序
const modules = Array.from(moduleMap.entries())
	.map(([name, posts]) => ({
		name,
		posts: posts.sort((a, b) => (b.date?.getTime() ?? 0) - (a.date?.getTime() ?? 0)),
	}))
	.sort((a, b) => a.name.localeCompare(b.name, "zh-CN")); // 按中文排序
---
<html lang="zh-cn">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>Lustre · 主页</title>
		<link rel="stylesheet" href="/src/styles/global.css" />
	</head>
	<body>
		<!-- Hero 背景图区域（全屏，带标题） -->
		<div class="hero-bg">
			<div class="hero-title">
				<h1 class="hero-title-main">Lustre's Blog</h1>
				<p class="hero-title-sub">Welcome to my digital space</p>
			</div>
			<div class="scroll-indicator">
				<span class="scroll-text">Scroll Down</span>
				<svg class="scroll-arrow" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
					<path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
				</svg>
			</div>
		</div>
		
		<!-- 内容区域（滚动后可见，渐变背景） -->
		<div class="content-section">
			<MainContent title="Lustre · 主页">
				<Fragment slot="sidebar">
					<Profile />
					<Spotify />
					<Statistics />
					<Tags />
				</Fragment>

				<div>
					<h1 style="font-size: 2rem; margin: 0 0 2rem 0;">文章分类</h1>
					{modules.length > 0 ? (
						<div class="modules-container">
							{modules.map((module, index) => (
								<div class="module-section" data-module-index={index}>
									<button class="module-title-button" data-module-index={index} type="button">
										<span class="module-title-text">{module.name}</span>
										<span class="module-count">({module.posts.length})</span>
										<svg class="module-arrow" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<path d="M6 9l6 6 6-6"/>
										</svg>
									</button>
									<div class="module-posts" data-module-index={index} style="display: none;">
										{module.posts.map((post) => (
											<PostCard
												title={post.title}
												{...(post.description ? { description: post.description } : {})}
												{...(post.date ? { date: post.date } : {})}
												url={post.url}
												{...(post.tags.length > 0 ? { tags: post.tags } : {})}
												{...(post.image ? { image: post.image } : {})}
												{...(post.imageAlt ? { imageAlt: post.imageAlt } : {})}
											/>
										))}
									</div>
								</div>
							))}
						</div>
					) : (
						<p style="text-align: center; color: rgba(249, 250, 251, 0.6); padding: 3rem;">
							暂无文章，敬请期待。
						</p>
					)}
				</div>
			</MainContent>
		</div>
	</body>
</html>

<style>
	.modules-container {
		display: flex;
		flex-direction: column;
		gap: 3rem;
	}

	.module-section {
		display: flex;
		flex-direction: column;
		gap: 1rem;
		margin-bottom: 1rem;
	}

	.module-title-button {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		width: 100%;
		padding: 1rem;
		background: rgba(255, 255, 255, 0.04);
		border: 1px solid rgba(255, 255, 255, 0.08);
		border-radius: 12px;
		cursor: pointer;
		transition: all 0.2s;
		text-align: left;
		font-size: 1.25rem;
		font-weight: 600;
		color: #8dd0ff;
		font-family: inherit;
	}

	.module-title-button:hover {
		background: rgba(91, 154, 255, 0.1);
		border-color: rgba(91, 154, 255, 0.3);
		transform: translateX(4px);
	}

	.module-title-text {
		flex: 1;
	}

	.module-count {
		font-size: 0.9rem;
		font-weight: normal;
		color: rgba(249, 250, 251, 0.6);
	}

	.module-arrow {
		transition: transform 0.2s;
		flex-shrink: 0;
	}

	.module-title-button[aria-expanded="true"] .module-arrow {
		transform: rotate(180deg);
	}

	.module-posts {
		display: flex;
		flex-direction: column;
		gap: 1rem;
		padding-left: 1rem;
		margin-top: 0.5rem;
		overflow: hidden;
		transition: all 0.3s ease;
	}

	.module-posts[data-expanded="true"] {
		display: flex;
	}
</style>

<script>
	// 折叠/展开功能
	document.addEventListener("DOMContentLoaded", () => {
		const buttons = document.querySelectorAll(".module-title-button");
		
		buttons.forEach((button) => {
			const index = button.getAttribute("data-module-index");
			const postsContainer = document.querySelector(
				`.module-posts[data-module-index="${index}"]`
			);
			
			if (!postsContainer) return;
			
			// 默认折叠
			button.setAttribute("aria-expanded", "false");
			postsContainer.setAttribute("data-expanded", "false");
			postsContainer.style.display = "none";
			
			button.addEventListener("click", () => {
				const isExpanded = button.getAttribute("aria-expanded") === "true";
				
				if (isExpanded) {
					// 折叠
					button.setAttribute("aria-expanded", "false");
					postsContainer.setAttribute("data-expanded", "false");
					postsContainer.style.display = "none";
				} else {
					// 展开
					button.setAttribute("aria-expanded", "true");
					postsContainer.setAttribute("data-expanded", "true");
					postsContainer.style.display = "flex";
				}
			});
		});
	});
</script>
